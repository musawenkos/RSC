@page
@model RoadSignCapture.Web.Pages.Users.CreateModel
@{
    ViewData["Title"] = "Create Command.Users";
}

<div class="container mx-auto px-4 py-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i class="bi bi-person-plus-fill text-blue-600"></i> Create User
        </h1>

        <a asp-page="Index"
           class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200
                  rounded-lg shadow-sm transition duration-200">
            <i class="bi bi-arrow-left-short mr-2"></i> Back to List
        </a>
    </div>

    <div class="bg-white shadow-md rounded-lg p-6 border border-gray-100">
        <form method="post" class="space-y-6">
            <div asp-validation-summary="ModelOnly" class="text-red-600 text-sm mb-3"></div>

            <!-- Email -->
            <div>
                <label asp-for="Command.Users.Email" class="block text-sm font-semibold text-gray-700 mb-1"></label>
                <input asp-for="Command.Users.Email" type="email"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500
                              focus:outline-none"
                       placeholder="Enter user email" />
                <span asp-validation-for="Command.Users.Email" class="text-red-600 text-xs"></span>
            </div>

            <!-- Display Name -->
            <div>
                <label asp-for="Command.Users.DisplayName" class="block text-sm font-semibold text-gray-700 mb-1"></label>
                <input asp-for="Command.Users.DisplayName"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500
                              focus:outline-none"
                       placeholder="Enter display name" />
                <span asp-validation-for="Command.Users.DisplayName" class="text-red-600 text-xs"></span>
            </div>

            <!-- Company -->
            <div class="flex items-end gap-2 mb-4">
                <!-- Existing company dropdown -->
                <div class="flex-1">
                    <label asp-for="Command.Users.CompanyId" class="block text-sm font-semibold text-gray-700 mb-1">
                        Company
                    </label>
                    <select asp-for="Command.Users.CompanyId" asp-items="ViewBag.CompanyId"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:ring-2
                       focus:ring-blue-500 focus:outline-none">
                        <option value="">-- Select Company --</option>
                    </select>
                    <span asp-validation-for="Command.Users.CompanyId" class="text-red-600 text-xs"></span>
                </div>

                <!-- + Add Company button -->
                <button id="btnAddCompany"
                        type="button"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg">
                    +
                </button>
            </div>

            <!-- Hidden form to add new company -->
            <div id="addCompanyForm" class="hidden border border-gray-300 rounded-lg p-4 mb-4 bg-gray-50">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Add New Company</h3>

                <div class="mb-2">
                    <label for="companyName" class="block text-sm font-medium text-gray-600">Company Name</label>
                    <input type="text" id="companyName" class="w-full border rounded-lg px-3 py-2" placeholder="Enter company name">
                </div>

                <div class="mb-2">
                    <label for="fullAddress" class="block text-sm font-medium text-gray-600">Full Address</label>
                    <input type="text" id="fullAddress" class="w-full border rounded-lg px-3 py-2" placeholder="Enter full address">
                </div>

                <div class="mb-3">
                    <label for="contactNumber" class="block text-sm font-medium text-gray-600">Contact Number</label>
                    <input type="text" id="contactNumber" class="w-full border rounded-lg px-3 py-2" placeholder="Enter contact number">
                </div>

                <div class="flex justify-end gap-2">
                    <button id="btnCancelAdd" type="button"
                            class="px-3 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button id="btnSaveCompany" type="button"
                            class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        Save
                    </button>
                </div>
            </div>

            <!-- Role -->
            <div>
                <label asp-for="Command.SelectedRoleId" class="block text-sm font-semibold text-gray-700 mb-1">Role</label>
                <select asp-for="Command.SelectedRoleId" asp-items="Model.RoleList"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus:ring-2
                               focus:ring-blue-500 focus:outline-none">
                    <option value="">-- Select Role --</option>
                </select>
                <span asp-validation-for="Command.SelectedRoleId" class="text-red-600 text-xs"></span>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-3 pt-4">
                <a asp-page="Index"
                   class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100
                          hover:bg-gray-200 rounded-lg shadow-sm transition">
                    Cancel
                </a>

                <button type="submit"
                        class="inline-flex items-center px-4 py-2 text-sm font-semibold text-white bg-blue-600
                               hover:bg-blue-700 rounded-lg shadow-md transition duration-200">
                    <i class="bi bi-check-circle mr-2"></i> Create User
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(function () {
            // Toggle the company form
            $("#btnAddCompany").on("click", function () {
                $("#addCompanyForm").toggleClass("hidden");
            });

            // Cancel button hides form
            $("#btnCancelAdd").on("click", function () {
                $("#addCompanyForm").addClass("hidden");
            });

            // Save new company
            $("#btnSaveCompany").on("click", async function () {
                const company = {
                    companyName: $("#companyName").val(),
                    fullAddress: $("#fullAddress").val(),
                    contactNumber: $("#contactNumber").val()
                };

                if (!company.companyName) {
                    alert("Please enter a company name.");
                    return;
                }

                try {
                    const response = await fetch("/rscapi/api/company", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(company)
                    });

                    if (response.ok) {
                        const newCompany = await response.json();
                        //console.log(newCompany)

                        // Add to dropdown dynamically
                        $("#Command_Users_CompanyId")
                            .append(`<option value="${newCompany.company.companyId}">${newCompany.company.companyName}</option>`)
                            .val(newCompany.company.companyId);

                        alert("Company added successfully!");
                        $("#addCompanyForm").addClass("hidden");
                        $("#companyName, #fullAddress, #contactNumber").val("");
                    } else {
                        const errorText = await response.text();
                        alert("Error adding company: " + errorText);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Failed to connect to the server.");
                }
            });
        });
    </script>
}
